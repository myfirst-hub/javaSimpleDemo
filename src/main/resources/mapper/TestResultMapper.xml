<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 修改namespace为完整的Mapper接口路径 -->
<mapper namespace="com.example.simpleDemo.mapper.TestResultMapper">

    <!-- 插入教师评论数据 -->
    <insert id="insertTeacherComment" parameterType="map" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO teacher_comment_result (
            subject_id,
            student_id,
            train_program_id,
            teacher_comment_content,
            teacher_comment_time
        ) VALUES (
            #{subjectId},
            #{studentId},
            #{trainProgramId},
            #{teacherCommentContent},
            #{teacherCommentTime}
        )
    </insert>

    <!-- 批量插入教师评论数据 -->
    <insert id="batchInsertTeacherComments" parameterType="list">
        INSERT INTO teacher_comment_result (
            subject_id,
            student_id,
            train_program_id,
            teacher_comment_content,
            teacher_comment_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.subjectId},
                #{item.studentId},
                #{item.trainProgramId},
                #{item.teacherCommentContent},
                #{item.teacherCommentTime}
            )
        </foreach>
    </insert>

    <!-- 定义TeacherCommentResultDTO的resultMap -->
    <resultMap id="TeacherCommentResultMap" type="com.example.simpleDemo.dto.TeacherCommentResultDTO">
        <id property="id" column="id"/>
        <result property="teacherCommentContent" column="teacher_comment_content"/>
        <result property="teacherCommentTime" column="teacher_comment_time"/>
        <result property="studentName" column="student_name"/>
        <result property="className" column="class_name"/>
        <result property="teacherName" column="teacher_name"/>
        <result property="subjectName" column="subject_name"/>
        <result property="theoryTrainProgramName" column="theory_train_program_name"/>
    </resultMap>

    <!-- 查询教师评论结果及相关信息 -->
    <select id="selectTeacherCommentResultWithDetails" resultMap="TeacherCommentResultMap">
        select tcr.id, tcr.teacher_comment_content, tcr.teacher_comment_time,
        s.name as student_name, c.name as class_name, c.teacher_name, c.subject_name, ttp.name as theory_train_program_name 
        from teacher_comment_result tcr
            inner join students s on s.id = tcr.student_id
            inner join subjects s2  on s2.id = tcr.subject_id
            inner join theory_train_program ttp on ttp.id = tcr.train_program_id
            left join class_student cs on s.id = cs.student_id
            left join classes c on cs.class_id = c.id
        <where>
            <if test="studentId != null">
                AND tcr.student_id = #{studentId}
            </if>
        </where>
    </select>

    <!-- 根据教师ID统计测试数量和总培训小时数 -->
    <select id="selectTestCountAndTrainHoursByTeacherId" resultType="map" parameterType="map">
        SELECT 
            COUNT(DISTINCT ttm.theory_test_id) AS theory_test_count,
            COALESCE(COUNT(DISTINCT ttm.theory_test_id) * ttp.train_time, 0) AS theory_total_train_hours
        FROM classes c
        LEFT JOIN theory_test_map ttm ON c.subject_id = ttm.subject_id AND ttm.student_id = #{studentId}
        LEFT JOIN theory_train_program ttp ON c.subject_id = ttp.subject_id
        <where>
            c.teacher_id = #{teacherId}
        </where>
        GROUP BY c.subject_id, ttp.train_time
    </select>

</mapper>